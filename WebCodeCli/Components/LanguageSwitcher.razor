@namespace WebCodeCli.Components
@inject WebCodeCli.Domain.Domain.Service.ILocalizationService LocalizationService
@inject IJSRuntime JSRuntime

<div class="relative inline-block text-left">
    <button @onclick="ToggleDropdown" 
            class="flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-colors"
            type="button">
        <!-- Globe Icon -->
        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129"></path>
        </svg>
        <span>@GetLanguageDisplayName(_currentLanguage)</span>
        <!-- Dropdown Arrow -->
        <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
    </button>

    @if (_isOpen)
    {
        <div class="absolute right-0 z-50 mt-2 w-48 origin-top-right rounded-lg bg-white shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none">
            <div class="py-1" role="menu">
                @foreach (var lang in _supportedLanguages)
                {
                    <button @onclick="() => ChangeLanguage(lang.Code)"
                            class="@GetLanguageItemClass(lang.Code) w-full text-left px-4 py-2 text-sm transition-colors"
                            role="menuitem">
                        <div class="flex items-center justify-between">
                            <span>@lang.NativeName</span>
                            @if (_currentLanguage == lang.Code)
                            {
                                <!-- Checkmark Icon -->
                                <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            }
                        </div>
                        <div class="text-xs text-gray-500 mt-0.5">@lang.Name</div>
                    </button>
                }
            </div>
        </div>
    }
</div>

@code {
    private bool _isOpen = false;
    private string _currentLanguage = "zh-CN";
    private List<WebCodeCli.Domain.Domain.Service.LanguageInfo> _supportedLanguages = new();

    [Parameter]
    public EventCallback<string> OnLanguageChanged { get; set; }

    protected override async Task OnInitializedAsync()
    {
        _supportedLanguages = LocalizationService.GetSupportedLanguages();
        _currentLanguage = await LocalizationService.GetCurrentLanguageAsync();
    }

    private void ToggleDropdown()
    {
        _isOpen = !_isOpen;
    }

    private async Task ChangeLanguage(string languageCode)
    {
        _isOpen = false;
        
        if (_currentLanguage != languageCode)
        {
            _currentLanguage = languageCode;
            await LocalizationService.SetCurrentLanguageAsync(languageCode);
            await LocalizationService.ReloadTranslationsAsync();
            
            // Notify parent component
            await OnLanguageChanged.InvokeAsync(languageCode);
            
            // Reload the page to apply new language
            await JSRuntime.InvokeVoidAsync("location.reload");
        }
    }

    private string GetLanguageDisplayName(string languageCode)
    {
        var lang = _supportedLanguages.FirstOrDefault(l => l.Code == languageCode);
        return lang?.NativeName ?? languageCode;
    }

    private string GetLanguageItemClass(string languageCode)
    {
        var baseClass = "hover:bg-gray-100";
        return _currentLanguage == languageCode
            ? $"{baseClass} bg-gray-50 font-semibold text-gray-900"
            : $"{baseClass} text-gray-700";
    }
}
