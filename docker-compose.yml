# ============================================
# WebCodeCli Docker Compose 配置
# 支持 Claude Code CLI 和 Codex CLI
# 一键部署：docker-compose up -d
# ============================================

version: '3.8'

services:
  webcodecli:
    build:
      context: .
      dockerfile: Dockerfile
    image: webcodecli:latest
    container_name: webcodecli
    restart: unless-stopped
    
    ports:
      - "${APP_PORT:-5000}:5000"
    
    environment:
      # ============================================
      # 应用配置（必需）
      # ============================================
      - ASPNETCORE_ENVIRONMENT=Production
      - TZ=Asia/Shanghai

      # ============================================
      # 数据库配置（Docker 环境使用 /app/data）
      # ============================================
      - DBConnection__ConnectionStrings=Data Source=/app/data/WebCodeCli.db
      - DBConnection__VectorConnection=/app/data/WebCodeCliMem.db

      # ============================================
      # Claude Code 环境变量配置
      # ============================================
      - ANTHROPIC_BASE_URL=${ANTHROPIC_BASE_URL}
      - ANTHROPIC_AUTH_TOKEN=${ANTHROPIC_AUTH_TOKEN}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL}
      - ANTHROPIC_SMALL_FAST_MODEL=${ANTHROPIC_SMALL_FAST_MODEL}

      # ============================================
      # Codex 环境变量配置
      # ============================================
      - NEW_API_KEY=${NEW_API_KEY}
      - CODEX_MODEL=${CODEX_MODEL}
      - CODEX_MODEL_REASONING_EFFORT=${CODEX_MODEL_REASONING_EFFORT}
      - CODEX_PROFILE=${CODEX_PROFILE}
      - CODEX_BASE_URL=${CODEX_BASE_URL}
      - CODEX_PROVIDER_NAME=${CODEX_PROVIDER_NAME}
      - CODEX_WIRE_API=${CODEX_WIRE_API}
      - CODEX_APPROVAL_POLICY=${CODEX_APPROVAL_POLICY}
      - CODEX_SANDBOX_MODE=${CODEX_SANDBOX_MODE}
      
    volumes:
      # 数据持久化（必需）
      - ./webcodecli-data:/app/data
      # 工作区持久化（自动挂载，无需手动配置）
      - ./webcodecli-workspaces:/app/workspaces
      # 日志持久化
      - ./webcodecli-logs:/app/logs
    
    # 资源限制
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
        reservations:
          cpus: '1'
          memory: 1G

    # 日志配置
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"
